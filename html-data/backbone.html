<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>backbone code</title>

  <script src="https://unpkg.com/mathjs@6.6.4/dist/math.min.js"></script>

  <style>
    body {
      font-family: sans-serif;
    }
  </style>
</head>
<body>
  <h1>Covid19</h1>
  <p>
    Backbone code. No GUI here for you :(
  </p>

  

  <script>
    // ------------------- ACTIVATE FOR MAXIMUM
    //math.config({
    //number: 'BigNumber',      // Default type of number:
    //                        // 'number' (default), 'BigNumber', or 'Fraction'
    //precision: 64             // Number of significant digits for BigNumbers
    //})

    function ndsolve(f, x0, dt, tmax) { //code for ndsolve from https://mathjs.org/examples/browser/rocket_trajectory_optimization.html.html
      const n = f.size()[0]  // Number of variables
      const x = x0.clone()   // Current values of variables
      const dxdt = []        // Temporary variable to hold time-derivatives
      const result = []      // Contains entire solution

      const nsteps = math.divide(tmax, dt)   // Number of time steps
      for(let i=0; i<nsteps; i++) {
        // Compute derivatives
        for(let j=0; j<n; j++) {
          dxdt[j] = f.get([j]).apply(null, x.toArray())
        }
        // Euler method to compute next time step
        for(let j=0; j<n; j++) {
          x.set([j], math.add(x.get([j]), math.multiply(dxdt[j], dt)))
        }
        result.push(x.clone())
      }

      return math.matrix(result)
    }

    // Import the numerical ODE solver
    math.import({ndsolve:ndsolve})

    // Create a math.js context for our simulation. Everything else occurs in the context of the expression parser!

    //-------------- MUSTERINPUT ----------------
    var nameOfCity = "Musterstadt"
    var numOfCases = "1000"
    var numOfPopulation = "100000"
    var recoveryRateInRegion = "0.55" //TODO: update daily for EVERY region


    var sdvalue = "0.3"
    //-------------- INPUT FROM USER ----------------

    function calcLivesSaved(nameOfCity, numOfCases, numOfPopulation, recoveryRateInRegion, sdvalue){ //OUR MAIN FUNCTION

      const sim = math.parser()
      var tfinal = "500" //how long the simulation keeps going... Always input an integer in string representation here!!

      console.log(sim.evaluate("estimatedRecovered = " + recoveryRateInRegion + " * " + numOfCases).toString()) //TODO: remove console.log / toString wrapper
      console.log(sim.evaluate("estimatedDead = 0.02 * " + numOfCases).toString())

      console.log(sim.evaluate("estimatedRemoved = estimatedRecovered + estimatedDead").toString())
      console.log(sim.evaluate("infectedPercentage = 1 - 0.02 - " + recoveryRateInRegion).toString())
      console.log(sim.evaluate("estimatedInfected = infectedPercentage * " + numOfCases).toString())

      sim.evaluate("s0 = 0.99")
      sim.evaluate("i0 = 0.01")
      sim.evaluate("r0 = 0.0")
      sim.evaluate("dt = 1.0")   // Simulation timestep
      sim.evaluate("tfinal = " + tfinal + ".0") // Simulation duration

      var a = "0.07470941883767536" //Always input the number as string here so Math.js can handle it with its own representation of the numbers!
      var b = "0.0714"
      sim.evaluate("dsdt(s,i,r) = - " + a + " * s * i")
      sim.evaluate("didt(s,i,r) = " + a + " * s * i - (" + b + " * i)")
      sim.evaluate("drdt(s,i,r) = " + b + " * i")

      const resultmatrix = sim.evaluate("resultmatrix = ndsolve([dsdt, didt, drdt], [s0, i0, r0], dt, tfinal)").toString()
      const result = sim.evaluate("resultmatrix.subset(index(" + tfinal + ", 3))").toString()
      return result
    }
  </script>

  <script>
    var result = calcLivesSaved(nameOfCity, numOfCases, numOfPopulation, recoveryRateInRegion, sdvalue)
    //document.write("Number of removed people: " + result + " with a = " + a + " and b = " + b)
    document.write("Number of removed people: " + result)
    //document.write(resultmatrix)
  </script>

  </script>
</body>
</html>
